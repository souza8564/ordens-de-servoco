<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Ordens de Serviço Interno</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #a9a9a9;
            -webkit-tap-highlight-color: transparent;
        }
        .main-layout {
            display: flex;
            min-height: 100vh;
            flex-direction: row;
        }
        .sidebar {
            width: 220px;
            background: #222;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            padding-top: 0;
            box-shadow: 2px 0 8px #0002;
            z-index: 10;
        }
        .sidebar-header {
            background:#39ff14;
            color:#111;
            text-align:center;
            border-radius:0 0 8px 8px;
            padding:24px 0 10px 0;
            box-shadow:0 0 8px #39ff14;
            margin-bottom: 18px;
            font-family:sans-serif;
            font-size:2em;
            letter-spacing:2px;
            font-weight:bold;
        }
        .sidebar-header .subtitle {
            font-size:0.8em;
            color:#00843d;
            font-weight:normal;
            display:block;
            margin-top:-2px;
            font-style:italic;
        }
        .sidebar-menu {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .sidebar-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            background: none;
            border: none;
            color: #fff;
            font-size: 1.08em;
            padding: 14px 24px;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
            text-align: left;
        }
        .sidebar-btn.active, .sidebar-btn:hover {
            background: #39ff14;
            color: #222;
        }
        .sidebar-btn svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 32px 32px 32px 32px;
            flex: 1;
            box-sizing: border-box;
        }
        .tabcontent {
            display: none;
            padding: 0;
            border: none;
            border-radius: 0;
            background: none;
            animation: fadeEffect 0.7s;
        }
        .tabcontent.active {
            display: block;
        }
        /* Estilos para formulários */
        .os-card {
            max-width: 700px;
            margin: 0 auto 32px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 16px #0001;
            padding: 32px 32px 24px 32px;
        }
        .os-card h2 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 24px;
            color: #00843d;
        }
        .os-card form {
            display: flex;
            flex-wrap: wrap;
            gap: 24px 32px;
        }
        .form-group {
            flex: 1 1 220px;
            min-width: 180px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        label {
            font-weight: 500;
            color: #222;
        }
        input[type="text"],
        input[type="date"],
        input[type="tel"],
        select,
        textarea {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            background: #f9f9f9;
            transition: border 0.2s;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="tel"]:focus,
        select:focus,
        textarea:focus {
            border: 1.5px solid #39ff14;
            outline: none;
        }
        button[type="submit"] {
            width: 100%;
            margin-top: 12px;
            padding: 12px 0;
            background: linear-gradient(90deg,#39ff14 60%,#00843d 100%);
            color: #111;
            font-weight: bold;
            font-size: 1.1em;
            border: none;
            border-radius: 6px;
            box-shadow: 0 2px 8px #39ff1422;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        button[type="submit"]:hover {
            background: linear-gradient(90deg,#00843d 0%,#39ff14 100%);
            color: #fff;
        }
        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .btn-edit {
            background-color: #00843d;
            color: white;
            margin-right: 5px;
        }
        .btn-delete {
            background-color: #d00;
            color: white;
        }
        .btn-print {
            background-color: #39f;
            color: white;
        }
        /* Status da OS */
        .status-pendente {
            color: #d00;
            font-weight: bold;
        }
        .status-andamento {
            color: #f90;
            font-weight: bold;
        }
        .status-concluida {
            color: #00843d;
            font-weight: bold;
        }
        .status-cancelada {
            color: #888;
            font-weight: bold;
        }
        /* Responsividade */
        @media (max-width: 900px) {
            .main-layout {
                flex-direction: column;
            }
            .sidebar {
                flex-direction: row;
                width: 100vw;
                height: auto;
                min-width: 0;
                max-width: 100vw;
                overflow-x: auto;
                box-shadow: 0 2px 8px #0002;
                border-radius: 0 0 12px 12px;
                padding: 0;
            }
            .sidebar-header {
                display: none;
            }
            .sidebar-menu {
                flex-direction: row;
                gap: 0;
                width: 100vw;
                overflow-x: auto;
            }
            .sidebar-btn {
                flex: 1 1 120px;
                min-width: 120px;
                font-size: 1em;
                padding: 12px 4px;
                justify-content: center;
                border-radius: 0;
                border-right: 1px solid #333;
            }
            .sidebar-btn:last-child {
                border-right: none;
            }
        }
        @media (max-width: 700px) {
            html {
                font-size: 15px;
            }
            .container {
                max-width: 100vw;
                padding: 4vw 0 18vw 0;
            }
            .os-card {
                padding: 10px 2vw 10px 2vw;
                max-width: 100vw;
                box-sizing: border-box;
            }
            .os-card form {
                flex-direction: column;
                gap: 12px;
                padding: 0;
            }
            .form-group {
                min-width: 0;
                width: 100%;
            }
            table {
                font-size: 0.97em;
            }
            th, td {
                padding: 6px 2px;
            }
            .sidebar {
                font-size: 0.95em;
            }
        }
        @media (max-width: 520px) {
            html {
                font-size: 14px;
            }
            .container {
                padding: 1vw 0 12vw 0;
            }
            .os-card {
                padding: 4px 0 4px 0;
            }
            table, th, td {
                font-size: 0.92em;
            }
            .sidebar-btn {
                min-width: 80px;
                font-size: 0.91em;
                padding: 8px 1px;
            }
        }
        /* Tabela responsiva */
        @media (max-width: 700px) {
            table {
                display: block;
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            thead {
                display: none;
            }
            tbody, tr, td {
                display: block;
                width: 100%;
            }
            tr {
                margin-bottom: 14px;
                border-radius: 10px;
                box-shadow: 0 1px 6px #0001;
                background: #fff;
                padding: 10px 0;
            }
            td {
                border: none;
                position: relative;
                padding-left: 46%;
                min-height: 32px;
                box-sizing: border-box;
                margin-bottom: 6px;
            }
            td:before {
                position: absolute;
                left: 8px;
                top: 8px;
                width: 44%;
                white-space: nowrap;
                font-weight: bold;
                color: #00843d;
                font-size: 0.98em;
            }
            #tabela-solicitantes td:nth-child(1):before { content: 'Nome'; }
            #tabela-solicitantes td:nth-child(2):before { content: 'Setor'; }
            #tabela-solicitantes td:nth-child(3):before { content: 'Contato'; }
            #tabela-solicitantes td:nth-child(4):before { content: 'Ações'; }
            
            #tabela-tecnicos td:nth-child(1):before { content: 'Nome'; }
            #tabela-tecnicos td:nth-child(2):before { content: 'Especialidade'; }
            #tabela-tecnicos td:nth-child(3):before { content: 'Contato'; }
            #tabela-tecnicos td:nth-child(4):before { content: 'Ações'; }
            
            #tabela-os td:nth-child(1):before { content: 'Número'; }
            #tabela-os td:nth-child(2):before { content: 'Solicitante'; }
            #tabela-os td:nth-child(3):before { content: 'Setor'; }
            #tabela-os td:nth-child(4):before { content: 'Equipamento'; }
            #tabela-os td:nth-child(5):before { content: 'Data'; }
            #tabela-os td:nth-child(6):before { content: 'Status'; }
            #tabela-os td:nth-child(7):before { content: 'Ações'; }
            
            #tabela-historico td:nth-child(1):before { content: 'Número'; }
            #tabela-historico td:nth-child(2):before { content: 'Solicitante'; }
            #tabela-historico td:nth-child(3):before { content: 'Setor'; }
            #tabela-historico td:nth-child(4):before { content: 'Equipamento'; }
            #tabela-historico td:nth-child(5):before { content: 'Data'; }
            #tabela-historico td:nth-child(6):before { content: 'Status'; }
            #tabela-historico td:nth-child(7):before { content: 'Ações'; }
        }
        /* Impressão */
        .print-only {
            display: none;
        }
        @media print {
            body > *:not(.print-only):not(.container) {
                display: none !important;
            }
            .print-only {
                display: block !important;
                page-break-after: always;
            }
            html, body {
                background: #fff !important;
            }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <nav class="sidebar">
            <div class="sidebar-header">
                ambipar <span class="subtitle">environment</span>
            </div>
            <div class="sidebar-menu">
                <button class="sidebar-btn active" data-tab="dashboard">
                    <svg viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg>
                    Painel
                </button>
                <button class="sidebar-btn" data-tab="solicitantes">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                    Solicitantes
                </button>
                <button class="sidebar-btn" data-tab="tecnicos">
                    <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/><path d="M10.05 16.05c-.73.73-1.15 1.15-1.8 2.2.71.14 1.46.22 2.25.22.79 0 1.54-.08 2.25-.22-.65-1.05-1.08-1.47-1.8-2.2-.47-.48-.84-.84-1.2-1.2-.36.36-.73.72-1.2 1.2z"/></svg>
                    Técnicos
                </button>
                <button class="sidebar-btn" data-tab="nova-os">
                    <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    Nova OS
                </button>
                <button class="sidebar-btn" data-tab="gerenciar-os">
                    <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zm0-6v2h14V7H7z"/></svg>
                    Gerenciar OS
                </button>
                <button class="sidebar-btn" data-tab="historico-os">
                    <svg viewBox="0 0 24 24"><path d="M13 3a9 9 0 1 0 8.95 10.11h-2.02A7 7 0 1 1 12 5v4l3.89-3.89L12 2v4a9 9 0 0 0 1 17.93V21a7 7 0 1 1 7-7h2a9 9 0 0 0-9-9z"/></svg>
                    Histórico
                </button>
                <button class="sidebar-btn" data-tab="relatorios">
                    <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"/></svg>
                    Relatórios
                </button>
            </div>
        </nav>
        <div class="container">
            <!-- Painel Dashboard -->
            <div id="dashboard" class="tabcontent active">
                <div class="os-card">
                    <h2>Painel de Controle</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #39ff14;">
                            <h3 style="margin-top: 0; color: #00843d;">OS Pendentes</h3>
                            <p style="font-size: 2em; font-weight: bold;" id="count-pendentes">0</p>
                        </div>
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #f90;">
                            <h3 style="margin-top: 0; color: #f90;">OS em Andamento</h3>
                            <p style="font-size: 2em; font-weight: bold;" id="count-andamento">0</p>
                        </div>
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; border-left: 5px solid #00843d;">
                            <h3 style="margin-top: 0; color: #00843d;">OS Concluídas</h3>
                            <p style="font-size: 2em; font-weight: bold;" id="count-concluidas">0</p>
                        </div>
                    </div>
                    
                    <h3>OS Urgentes</h3>
                    <div id="os-urgentes" style="margin-bottom: 30px;"></div>
                    
                    <h3>Próximos Vencimentos</h3>
                    <div id="proximos-vencimentos"></div>
                </div>
            </div>
            
            <!-- Cadastro de Solicitantes -->
            <div id="solicitantes" class="tabcontent">
                <div class="os-card">
                    <h2>Cadastrar Solicitante</h2>
                    <form id="solicitanteForm">
                        <div class="form-group">
                            <label for="solicitante-nome">Nome:</label>
                            <input type="text" id="solicitante-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="solicitante-setor">Setor:</label>
                            <select id="solicitante-setor" required>
                                <option value="">Selecione um setor</option>
                                <option value="Produção">Produção</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Qualidade">Qualidade</option>
                                <option value="Logística">Logística</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="solicitante-contato">Contato:</label>
                            <input type="tel" id="solicitante-contato" required>
                        </div>
                        <button type="submit">Salvar Solicitante</button>
                    </form>
                </div>
                
                <div class="os-card">
                    <h3>Solicitantes Cadastrados</h3>
                    <table id="tabela-solicitantes">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Setor</th>
                                <th>Contato</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Cadastro de Técnicos -->
            <div id="tecnicos" class="tabcontent">
                <div class="os-card">
                    <h2>Cadastrar Técnico</h2>
                    <form id="tecnicoForm">
                        <div class="form-group">
                            <label for="tecnico-nome">Nome:</label>
                            <input type="text" id="tecnico-nome" required>
                        </div>
                        <div class="form-group">
                            <label for="tecnico-especialidade">Especialidade:</label>
                            <select id="tecnico-especialidade" required>
                                <option value="">Selecione</option>
                                <option value="Eletricista">Eletricista</option>
                                <option value="Mecânico">Mecânico</option>
                                <option value="Eletrônico">Eletrônico</option>
                                <option value="Informática">Informática</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="tecnico-contato">Contato:</label>
                            <input type="tel" id="tecnico-contato" required>
                        </div>
                        <button type="submit">Salvar Técnico</button>
                    </form>
                </div>
                
                <div class="os-card">
                    <h3>Técnicos Cadastrados</h3>
                    <table id="tabela-tecnicos">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Especialidade</th>
                                <th>Contato</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Nova Ordem de Serviço -->
            <div id="nova-os" class="tabcontent">
                <div class="os-card">
                    <h2>Nova Ordem de Serviço</h2>
                    <form id="osForm">
                        <div class="form-group">
                            <label for="os-solicitante">Solicitante:</label>
                            <select id="os-solicitante" required>
                                <option value="">Selecione um solicitante</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-setor">Setor:</label>
                            <select id="os-setor" required>
                                <option value="">Selecione um setor</option>
                                <option value="Produção">Produção</option>
                                <option value="Manutenção">Manutenção</option>
                                <option value="Qualidade">Qualidade</option>
                                <option value="Logística">Logística</option>
                                <option value="Administrativo">Administrativo</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-equipamento">Equipamento:</label>
                            <input type="text" id="os-equipamento" required>
                        </div>
                        <div class="form-group">
                            <label for="os-serial">Número de Patrimônio:</label>
                            <input type="text" id="os-serial">
                        </div>
                        <div class="form-group">
                            <label for="os-tecnico">Técnico Responsável:</label>
                            <select id="os-tecnico" required>
                                <option value="">Selecione um técnico</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="os-data">Data de Abertura:</label>
                            <input type="date" id="os-data" required>
                        </div>
                        <div class="form-group">
                            <label for="os-prazo">Prazo para Conclusão:</label>
                            <input type="date" id="os-prazo">
                        </div>
                        <div class="form-group">
                            <label for="os-problema">Problema Relatado:</label>
                            <textarea id="os-problema" rows="3" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="os-diagnostico">Diagnóstico Técnico:</label>
                            <textarea id="os-diagnostico" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="os-solucao">Solução Aplicada:</label>
                            <textarea id="os-solucao" rows="3"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="os-status">Status:</label>
                            <select id="os-status" required>
                                <option value="pendente">Pendente</option>
                                <option value="andamento">Em Andamento</option>
                                <option value="concluida">Concluída</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                        <button type="submit">Salvar OS</button>
                    </form>
                </div>
            </div>
            
            <!-- Gerenciar OS -->
            <div id="gerenciar-os" class="tabcontent">
                <div class="os-card">
                    <h2>Gerenciar Ordens de Serviço</h2>
                    <div style="margin-bottom: 20px;">
                        <label for="filtro-status">Filtrar por Status:</label>
                        <select id="filtro-status">
                            <option value="">Todos</option>
                            <option value="pendente">Pendentes</option>
                            <option value="andamento">Em Andamento</option>
                            <option value="concluida">Concluídas</option>
                            <option value="cancelada">Canceladas</option>
                        </select>
                        <label for="filtro-tecnico" style="margin-left: 15px;">Filtrar por Técnico:</label>
                        <select id="filtro-tecnico">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <table id="tabela-os">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Solicitante</th>
                                <th>Setor</th>
                                <th>Equipamento</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Histórico de OS -->
            <div id="historico-os" class="tabcontent">
                <div class="os-card">
                    <h2>Histórico de Ordens de Serviço</h2>
                    <div style="margin-bottom: 20px;">
                        <label for="historico-setor">Filtrar por Setor:</label>
                        <select id="historico-setor">
                            <option value="">Todos</option>
                            <option value="Produção">Produção</option>
                            <option value="Manutenção">Manutenção</option>
                            <option value="Qualidade">Qualidade</option>
                            <option value="Logística">Logística</option>
                            <option value="Administrativo">Administrativo</option>
                            <option value="Outros">Outros</option>
                        </select>
                        <label for="historico-periodo" style="margin-left: 15px;">Período:</label>
                        <select id="historico-periodo">
                            <option value="30">Últimos 30 dias</option>
                            <option value="90">Últimos 90 dias</option>
                            <option value="365">Últimos 12 meses</option>
                            <option value="0">Todo o período</option>
                        </select>
                    </div>
                    <table id="tabela-historico">
                        <thead>
                            <tr>
                                <th>Número</th>
                                <th>Solicitante</th>
                                <th>Setor</th>
                                <th>Equipamento</th>
                                <th>Data</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <div style="margin-top: 20px;">
                        <button onclick="exportarHistoricoExcel()">Exportar para Excel</button>
                        <button onclick="imprimirHistorico()" style="margin-left: 10px;">Imprimir Relatório</button>
                    </div>
                </div>
            </div>
            
            <!-- Relatórios -->
            <div id="relatorios" class="tabcontent">
                <div class="os-card">
                    <h2>Relatórios</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #00843d;">OS por Status</h3>
                            <canvas id="chart-status" height="200"></canvas>
                        </div>
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #00843d;">OS por Técnico</h3>
                            <canvas id="chart-tecnicos" height="200"></canvas>
                        </div>
                        <div style="background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin-top: 0; color: #00843d;">OS por Setor</h3>
                            <canvas id="chart-setores" height="200"></canvas>
                        </div>
                    </div>
                    <div style="margin-top: 30px;">
                        <button onclick="gerarRelatorioCompleto()">Gerar Relatório Completo</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para visualização/impressão de OS -->
    <div id="modal-os" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow: auto;">
        <div style="background: white; max-width: 800px; margin: 30px auto; padding: 30px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.2);">
            <div id="os-print-content">
                <!-- Conteúdo da OS será inserido aqui -->
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button onclick="imprimirOS()" style="padding: 10px 20px; background: #39ff14; color: #111; border: none; border-radius: 5px; font-weight: bold; cursor: pointer;">Imprimir OS</button>
                <button onclick="fecharModalOS()" style="padding: 10px 20px; background: #d00; color: white; border: none; border-radius: 5px; margin-left: 15px; font-weight: bold; cursor: pointer;">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Firebase App (core) SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <!-- Firebase Firestore SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
      // Configuração do Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyD4FH7GjivSwsnhqCGvYdYd6AYpLrulGRQ",
        authDomain: "ordens-servico-37369.firebaseapp.com",
        projectId: "ordens-servico-37369",
        storageBucket: "ordens-servico-37369.firebasestorage.app",
        messagingSenderId: "956106820939",
        appId: "1:956106820939:web:fb5df0102c23c506036cce",
        measurementId: "G-15FMG1E6BM"
      };
      // Inicializa Firebase
      firebase.initializeApp(firebaseConfig);
      // Inicializa Firestore
      const db = firebase.firestore();
    </script>

    <script>
        // Banco de dados local
        let solicitantes = [];
        let tecnicos = JSON.parse(localStorage.getItem('tecnicos')) || [];
        let ordensServico = JSON.parse(localStorage.getItem('ordensServico')) || [];
        let ultimoNumeroOS = parseInt(localStorage.getItem('ultimoNumeroOS')) || 0;

        // Inicialização do sistema
        document.addEventListener('DOMContentLoaded', async function() {
            // Carrega solicitantes do Firestore
            await carregarSolicitantesFirestore();
            
            // Configura navegação entre abas
            const sidebarBtns = document.querySelectorAll('.sidebar-btn');
            const tabContents = document.querySelectorAll('.tabcontent');
            
            sidebarBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove 'active' de todos os botões e abas
                    sidebarBtns.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(tab => tab.classList.remove('active'));
                    
                    // Adiciona 'active' ao botão clicado e à aba correspondente
                    this.classList.add('active');
                    const tabId = this.getAttribute('data-tab');
                    const tab = document.getElementById(tabId);
                    if (tab) tab.classList.add('active');
                    
                    // Atualiza dados específicos da aba quando aberta
                    if (tabId === 'dashboard') atualizarDashboard();
                    if (tabId === 'solicitantes') atualizarTabelaSolicitantes();
                    if (tabId === 'tecnicos') atualizarTabelaTecnicos();
                    if (tabId === 'gerenciar-os') atualizarTabelaOS();
                    if (tabId === 'historico-os') atualizarTabelaHistorico();
                    if (tabId === 'relatorios') atualizarRelatorios();
                });
            });
            
            // Garante que a primeira aba esteja ativa ao carregar
            const btnAtivo = document.querySelector('.sidebar-btn.active');
            if (btnAtivo) {
                const tabId = btnAtivo.getAttribute('data-tab');
                const tab = document.getElementById(tabId);
                if (tab) tab.classList.add('active');
            }
            
            // Inicializa selects
            atualizarSelectSolicitantes();
            atualizarSelectTecnicos();
            atualizarSelectFiltroTecnicos();
            
            // Configura formulários
            configurarFormularios();
            
            // Atualiza dashboard
            atualizarDashboard();
            
            // Atualiza tabelas
            atualizarTabelaSolicitantes();
            atualizarTabelaTecnicos();
            atualizarTabelaOS();
            atualizarTabelaHistorico();
            
            // Configura data atual no formulário de OS
            document.getElementById('os-data').valueAsDate = new Date();
        });

        // Funções Firestore para Solicitantes
async function carregarSolicitantesFirestore() {
    const snapshot = await db.collection('solicitantes').get();
    solicitantes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function adicionarSolicitanteFirestore(solicitante) {
    const docRef = await db.collection('solicitantes').add(solicitante);
    solicitante.id = docRef.id;
    solicitantes.push(solicitante);
}

async function atualizarSolicitanteFirestore(id, dados) {
    await db.collection('solicitantes').doc(id).update(dados);
    const idx = solicitantes.findIndex(s => s.id === id);
    if (idx !== -1) solicitantes[idx] = { ...solicitantes[idx], ...dados };
}

async function removerSolicitanteFirestore(id) {
    await db.collection('solicitantes').doc(id).delete();
    solicitantes = solicitantes.filter(s => s.id !== id);
}

// Funções Firestore para Técnicos
async function carregarTecnicosFirestore() {
    const snapshot = await db.collection('tecnicos').get();
    tecnicos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function adicionarTecnicoFirestore(tecnico) {
    const docRef = await db.collection('tecnicos').add(tecnico);
    tecnico.id = docRef.id;
    tecnicos.push(tecnico);
}

async function atualizarTecnicoFirestore(id, dados) {
    await db.collection('tecnicos').doc(id).update(dados);
    const idx = tecnicos.findIndex(t => t.id === id);
    if (idx !== -1) tecnicos[idx] = { ...tecnicos[idx], ...dados };
}

async function removerTecnicoFirestore(id) {
    await db.collection('tecnicos').doc(id).delete();
    tecnicos = tecnicos.filter(t => t.id !== id);
}

// Funções Firestore para Ordens de Serviço
async function carregarOSFirestore() {
    const snapshot = await db.collection('ordensServico').get();
    ordensServico = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
}

async function adicionarOSFirestore(os) {
    const docRef = await db.collection('ordensServico').add(os);
    os.id = docRef.id;
    ordensServico.push(os);
}

async function atualizarOSFirestore(id, dados) {
    await db.collection('ordensServico').doc(id).update(dados);
    const idx = ordensServico.findIndex(o => o.id === id);
    if (idx !== -1) ordensServico[idx] = { ...ordensServico[idx], ...dados };
}

async function removerOSFirestore(id) {
    await db.collection('ordensServico').doc(id).delete();
    ordensServico = ordensServico.filter(o => o.id !== id);
}

// Refatora formulário de cadastro de técnico
function configurarFormularios() {
    // Formulário de solicitante
    const solicitanteForm = document.getElementById('solicitanteForm');
    if (solicitanteForm) {
        solicitanteForm.onsubmit = async function(e) {
            e.preventDefault();
            const nome = document.getElementById('solicitante-nome').value.trim();
            const setor = document.getElementById('solicitante-setor').value;
            const contato = document.getElementById('solicitante-contato').value.trim();
            if (!nome || !setor || !contato) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }
            const solicitante = { nome, setor, contato };
            await adicionarSolicitanteFirestore(solicitante);
            await carregarSolicitantesFirestore();
            atualizarTabelaSolicitantes();
            atualizarSelectSolicitantes();
            solicitanteForm.reset();
            alert('Solicitante cadastrado com sucesso!');
        };
    }
    
    // Formulário de técnico
    const tecnicoForm = document.getElementById('tecnicoForm');
    if (tecnicoForm) {
        tecnicoForm.onsubmit = async function(e) {
            e.preventDefault();
            const nome = document.getElementById('tecnico-nome').value.trim();
            const especialidade = document.getElementById('tecnico-especialidade').value;
            const contato = document.getElementById('tecnico-contato').value.trim();
            if (!nome || !especialidade || !contato) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }
            const tecnico = { nome, especialidade, contato };
            await adicionarTecnicoFirestore(tecnico);
            await carregarTecnicosFirestore();
            atualizarTabelaTecnicos();
            atualizarSelectTecnicos();
            atualizarSelectFiltroTecnicos();
            tecnicoForm.reset();
            alert('Técnico cadastrado com sucesso!');
        };
    }
    
    // Formulário de OS
    const osForm = document.getElementById('osForm');
    if (osForm) {
        osForm.onsubmit = async function(e) {
            e.preventDefault();
            const solicitanteId = document.getElementById('os-solicitante').value;
            const setor = document.getElementById('os-setor').value;
            const equipamento = document.getElementById('os-equipamento').value.trim();
            const serial = document.getElementById('os-serial').value.trim();
            const tecnicoId = document.getElementById('os-tecnico').value;
            const data = document.getElementById('os-data').value;
            const prazo = document.getElementById('os-prazo').value;
            const problema = document.getElementById('os-problema').value.trim();
            const diagnostico = document.getElementById('os-diagnostico').value.trim();
            const solucao = document.getElementById('os-solucao').value.trim();
            const status = document.getElementById('os-status').value;
            if (!solicitanteId || !setor || !equipamento || !tecnicoId || !data || !problema) {
                alert('Preencha todos os campos obrigatórios.');
                return;
            }
            // Incrementa número da OS
            ultimoNumeroOS++;
            localStorage.setItem('ultimoNumeroOS', ultimoNumeroOS);
            const os = {
                numero: ultimoNumeroOS,
                solicitanteId,
                setor,
                equipamento,
                serial,
                tecnicoId,
                data,
                prazo,
                problema,
                diagnostico,
                solucao,
                status,
                dataConclusao: status === 'concluida' ? new Date().toISOString().split('T')[0] : null
            };
            await adicionarOSFirestore(os);
            await carregarOSFirestore();
            atualizarTabelaOS();
            atualizarTabelaHistorico();
            atualizarDashboard();
            osForm.reset();
            document.getElementById('os-data').valueAsDate = new Date();
            alert(`Ordem de Serviço #${ultimoNumeroOS} cadastrada com sucesso!`);
            if (confirm('Deseja imprimir esta ordem de serviço?')) {
                visualizarOS(os.id);
            }
        };
    }
    
    // Filtros da tabela OS
    document.getElementById('filtro-status').addEventListener('change', atualizarTabelaOS);
    document.getElementById('filtro-tecnico').addEventListener('change', atualizarTabelaOS);
    
    // Filtros do histórico
    document.getElementById('historico-setor').addEventListener('change', atualizarTabelaHistorico);
    document.getElementById('historico-periodo').addEventListener('change', atualizarTabelaHistorico);
}

// Funções para atualizar tabelas
async function atualizarTabelaSolicitantes() {
    await carregarSolicitantesFirestore();
    const tbody = document.querySelector('#tabela-solicitantes tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    solicitantes.forEach(solicitante => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${solicitante.nome}</td>
            <td>${solicitante.setor}</td>
            <td>${solicitante.contato}</td>
            <td>
                <button class="btn-action btn-edit" data-id="${solicitante.id}">Editar</button>
                <button class="btn-action btn-delete" data-id="${solicitante.id}">Remover</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const solicitanteId = this.getAttribute('data-id');
            editarSolicitante(solicitanteId);
        });
    });
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', async function() {
            const solicitanteId = this.getAttribute('data-id');
            if (confirm('Tem certeza que deseja remover este solicitante?')) {
                await removerSolicitanteFirestore(solicitanteId);
                await carregarSolicitantesFirestore();
                atualizarTabelaSolicitantes();
                atualizarSelectSolicitantes();
            }
        });
    });
}

function atualizarTabelaTecnicos() {
    const tbody = document.querySelector('#tabela-tecnicos tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    tecnicos.forEach(tecnico => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${tecnico.nome}</td>
            <td>${tecnico.especialidade}</td>
            <td>${tecnico.contato}</td>
            <td>
                <button class="btn-action btn-edit" data-id="${tecnico.id}">Editar</button>
                <button class="btn-action btn-delete" data-id="${tecnico.id}">Remover</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Configura eventos dos botões
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const tecnicoId = this.getAttribute('data-id');
            editarTecnico(tecnicoId);
        });
    });
    
    document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', function() {
            const tecnicoId = this.getAttribute('data-id');
            if (confirm('Tem certeza que deseja remover este técnico?')) {
                tecnicos = tecnicos.filter(t => t.id !== tecnicoId);
                localStorage.setItem('tecnicos', JSON.stringify(tecnicos));
                atualizarTabelaTecnicos();
                atualizarSelectTecnicos();
                atualizarSelectFiltroTecnicos();
            }
        });
    });
}

function atualizarTabelaOS() {
    const tbody = document.querySelector('#tabela-os tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const filtroStatus = document.getElementById('filtro-status').value;
    const filtroTecnico = document.getElementById('filtro-tecnico').value;
    
    let osFiltradas = ordensServico.filter(os => {
        // Filtra por status se selecionado
        if (filtroStatus && os.status !== filtroStatus) return false;
        
        // Filtra por técnico se selecionado
        if (filtroTecnico && os.tecnicoId !== filtroTecnico) return false;
        
        return true;
    });
    
    // Ordena por data (mais recente primeiro)
    osFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    osFiltradas.forEach(os => {
        const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
        const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
        
        let statusClass = '';
        if (os.status === 'pendente') statusClass = 'status-pendente';
        else if (os.status === 'andamento') statusClass = 'status-andamento';
        else if (os.status === 'concluida') statusClass = 'status-concluida';
        else if (os.status === 'cancelada') statusClass = 'status-cancelada';
        
        const statusSelect = `
<select class="status-select" data-id="${os.id}">
    <option value="pendente" ${os.status === 'pendente' ? 'selected' : ''}>Pendente</option>
    <option value="andamento" ${os.status === 'andamento' ? 'selected' : ''}>Em Andamento</option>
    <option value="concluida" ${os.status === 'concluida' ? 'selected' : ''}>Concluída</option>
    <option value="cancelada" ${os.status === 'cancelada' ? 'selected' : ''}>Cancelada</option>
</select>
`;

        tr = document.createElement('tr');
        tr.innerHTML = `
            <td>#${os.numero}</td>
            <td>${solicitante.nome || 'Solicitante não encontrado'}</td>
            <td>${os.setor}</td>
            <td>${os.equipamento}</td>
            <td>${formatarData(os.data)}</td>
            <td class="${statusClass}">${statusSelect}</td>
            <td>
                <button class="btn-action btn-edit" data-id="${os.id}">Editar</button>
                <button class="btn-action btn-view" data-id="${os.id}">Visualizar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Configura eventos dos botões
    document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', function() {
            const osId = this.getAttribute('data-id');
            editarOS(osId);
        });
    });
    
    document.querySelectorAll('.btn-view').forEach(btn => {
        btn.addEventListener('click', function() {
            const osId = this.getAttribute('data-id');
            abrirOSNovaPagina(osId);
        });
    });
    
    // Adiciona evento para alteração de status
    document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async function() {
            const osId = this.getAttribute('data-id');
            const novaStatus = this.value;
            const os = ordensServico.find(o => o.id === osId);
            if (os) {
                os.status = novaStatus;
                if (novaStatus === 'concluida') {
                    os.dataConclusao = new Date().toISOString().split('T')[0];
                } else {
                    os.dataConclusao = null;
                }
                await atualizarOSFirestore(osId, { status: novaStatus, dataConclusao: os.dataConclusao });
                await carregarOSFirestore();
                atualizarTabelaOS();
                atualizarTabelaHistorico();
                atualizarDashboard();
            }
        });
    });
}
        
function atualizarTabelaHistorico() {
    const tbody = document.querySelector('#tabela-historico tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const filtroSetor = document.getElementById('historico-setor').value;
    const periodo = parseInt(document.getElementById('historico-periodo').value);
    
    let hoje = new Date();
    let dataLimite = new Date();
    if (periodo > 0) {
        dataLimite.setDate(hoje.getDate() - periodo);
    }
    
    let osFiltradas = ordensServico.filter(os => {
        // Filtra por setor se selecionado
        if (filtroSetor && os.setor !== filtroSetor) return false;
        
        // Filtra por período se selecionado
        if (periodo > 0) {
            const dataOS = new Date(os.data);
            return dataOS >= dataLimite;
        }
        
        return true;
    });
    
    // Ordena por data (mais recente primeiro)
    osFiltradas.sort((a, b) => new Date(b.data) - new Date(a.data));
    
    osFiltradas.forEach(os => {
        const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
        const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
        
        let statusClass = '';
        if (os.status === 'pendente') statusClass = 'status-pendente';
        else if (os.status === 'andamento') statusClass = 'status-andamento';
        else if (os.status === 'concluida') statusClass = 'status-concluida';
        else if (os.status === 'cancelada') statusClass = 'status-cancelada';
        
        const statusText = os.status === 'pendente' ? 'Pendente' :
                          os.status === 'andamento' ? 'Em Andamento' :
                          os.status === 'concluida' ? 'Concluída' : 'Cancelada';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>#${os.numero}</td>
            <td>${solicitante.nome || 'Solicitante não encontrado'}</td>
            <td>${os.setor}</td>
            <td>${os.equipamento}</td>
            <td>${formatarData(os.data)}</td>
            <td class="${statusClass}">${statusText}</td>
            <td>
                <button class="btn-action btn-print" data-id="${os.id}">Imprimir</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    
    // Configura eventos dos botões
    document.querySelectorAll('.btn-print').forEach(btn => {
        btn.addEventListener('click', function() {
            const osId = this.getAttribute('data-id');
            visualizarOS(osId);
        });
    });
}

// Funções para edição de registros
async function editarSolicitante(solicitanteId) {
    const solicitante = solicitantes.find(s => s.id === solicitanteId);
    if (!solicitante) return;
    
    const novoNome = prompt('Nome:', solicitante.nome);
    if (novoNome === null) return;
    
    const novoSetor = prompt('Setor:', solicitante.setor);
    if (novoSetor === null) return;
    
    const novoContato = prompt('Contato:', solicitante.contato);
    if (novoContato === null) return;
    
    const dados = {
        nome: novoNome.trim(),
        setor: novoSetor.trim(),
        contato: novoContato.trim()
    };
    await atualizarSolicitanteFirestore(solicitanteId, dados);
    await carregarSolicitantesFirestore();
    atualizarTabelaSolicitantes();
    atualizarSelectSolicitantes();
}

async function editarTecnico(tecnicoId) {
    const tecnico = tecnicos.find(t => t.id === tecnicoId);
    if (!tecnico) return;
    
    const novoNome = prompt('Nome:', tecnico.nome);
    if (novoNome === null) return;
    
    const novaEspecialidade = prompt('Especialidade:', tecnico.especialidade);
    if (novaEspecialidade === null) return;
    
    const novoContato = prompt('Contato:', tecnico.contato);
    if (novoContato === null) return;
    
    const dados = {
        nome: novoNome.trim(),
        especialidade: novaEspecialidade.trim(),
        contato: novoContato.trim()
    };
    await atualizarTecnicoFirestore(tecnicoId, dados);
    await carregarTecnicosFirestore();
    atualizarTabelaTecnicos();
    atualizarSelectTecnicos();
    atualizarSelectFiltroTecnicos();
}

async function editarOS(osId) {
    await carregarOSFirestore();
    const os = ordensServico.find(o => o.id === osId);
    if (!os) return;
    
    // Abre o formulário de OS com os dados preenchidos
    document.querySelector('[data-tab="nova-os"]').click();
    
    // Preenche os campos do formulário
    document.getElementById('os-solicitante').value = os.solicitanteId;
    document.getElementById('os-setor').value = os.setor;
    document.getElementById('os-equipamento').value = os.equipamento;
    document.getElementById('os-serial').value = os.serial || '';
    document.getElementById('os-tecnico').value = os.tecnicoId;
    document.getElementById('os-data').value = os.data;
    document.getElementById('os-prazo').value = os.prazo || '';
    document.getElementById('os-problema').value = os.problema;
    document.getElementById('os-diagnostico').value = os.diagnostico || '';
    document.getElementById('os-solucao').value = os.solucao || '';
    document.getElementById('os-status').value = os.status;
    
    // Remove a OS antiga do Firestore
    await removerOSFirestore(osId);
    await carregarOSFirestore();
    alert('Edite os dados da OS e clique em "Salvar OS" para confirmar as alterações.');
}

// Funções para o dashboard
function atualizarDashboard() {
    // Contagem por status
    const pendentes = ordensServico.filter(os => os.status === 'pendente').length;
    const andamento = ordensServico.filter(os => os.status === 'andamento').length;
    const concluidas = ordensServico.filter(os => os.status === 'concluida').length;
    
    document.getElementById('count-pendentes').textContent = pendentes;
    document.getElementById('count-andamento').textContent = andamento;
    document.getElementById('count-concluidas').textContent = concluidas;
    
    // OS urgentes (pendentes ou em andamento com prazo vencido ou próximo)
    const hoje = new Date();
    const osUrgentes = ordensServico.filter(os => {
        if (os.status !== 'pendente' && os.status !== 'andamento') return false;
        if (!os.prazo) return false;
        
        const prazo = new Date(os.prazo);
        const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
        
        return diffDias <= 3; // Prazo vence em até 3 dias
    });
    
    const divUrgentes = document.getElementById('os-urgentes');
    divUrgentes.innerHTML = '';
    
    if (osUrgentes.length === 0) {
        divUrgentes.innerHTML = '<p>Nenhuma OS urgente no momento.</p>';
        return;
    }
    
    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>Número</th>
                <th>Solicitante</th>
                <th>Setor</th>
                <th>Equipamento</th>
                <th>Prazo</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbody = table.querySelector('tbody');
    
    osUrgentes.forEach(os => {
        const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
        const prazo = new Date(os.prazo);
        const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
        
        let statusClass = os.status === 'pendente' ? 'status-pendente' : 'status-andamento';
        let statusText = os.status === 'pendente' ? 'Pendente' : 'Em Andamento';
        
        let prazoText = formatarData(os.prazo);
        if (diffDias < 0) prazoText += ' (Vencido)';
        else if (diffDias === 0) prazoText += ' (Hoje)';
        else if (diffDias === 1) prazoText += ' (Amanhã)';
        else prazoText += ` (Em ${diffDias} dias)`;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>#${os.numero}</td>
            <td>${solicitante.nome || 'Solicitante não encontrado'}</td>
            <td>${os.setor}</td>
            <td>${os.equipamento}</td>
            <td>${prazoText}</td>
            <td class="${statusClass}">${statusText}</td>
        `;
        tbody.appendChild(tr);
    });
    
    divUrgentes.appendChild(table);
    
    // Próximos vencimentos
    const divProximos = document.getElementById('proximos-vencimentos');
    divProximos.innerHTML = '';
    
    const osProximas = ordensServico.filter(os => {
        if (os.status !== 'pendente' && os.status !== 'andamento') return false;
        if (!os.prazo) return false;
        
        const prazo = new Date(os.prazo);
        const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
        
        return diffDias > 3 && diffDias <= 7; // Prazo entre 4 e 7 dias
    });
    
    if (osProximas.length === 0) {
        divProximos.innerHTML = '<p>Nenhuma OS com vencimento próximo.</p>';
        return;
    }
    
    const tableProximas = document.createElement('table');
    tableProximas.innerHTML = `
        <thead>
            <tr>
                <th>Número</th>
                <th>Solicitante</th>
                <th>Setor</th>
                <th>Equipamento</th>
                <th>Prazo</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    
    const tbodyProximas = tableProximas.querySelector('tbody');
    
    osProximas.forEach(os => {
        const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
        const prazo = new Date(os.prazo);
        const diffDias = Math.floor((prazo - hoje) / (1000 * 60 * 60 * 24));
        
        let statusClass = os.status === 'pendente' ? 'status-pendente' : 'status-andamento';
        let statusText = os.status === 'pendente' ? 'Pendente' : 'Em Andamento';
        
        let prazoText = formatarData(os.prazo) + ` (Em ${diffDias} dias)`;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>#${os.numero}</td>
            <td>${solicitante.nome || 'Solicitante não encontrado'}</td>
            <td>${os.setor}</td>
            <td>${os.equipamento}</td>
            <td>${prazoText}</td>
            <td class="${statusClass}">${statusText}</td>
        `;
        tbodyProximas.appendChild(tr);
    });
    
    divProximos.appendChild(tableProximas);
}

// Funções para visualização e impressão de OS
function visualizarOS(osId) {
    const os = ordensServico.find(o => o.id === osId);
    if (!os) return;
    
    const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
    const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
    
    let statusText = os.status === 'pendente' ? 'Pendente' :
                    os.status === 'andamento' ? 'Em Andamento' :
                    os.status === 'concluida' ? 'Concluída' : 'Cancelada';
    
    const html = `
        <style>
            body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
            .os-container {
                max-width: 600px;
                margin: 16px auto;
                background: #fff;
                border-radius: 8px;
                box-shadow: 0 1px 6px #0001;
                padding: 18px 22px 12px 22px;
                font-size: 13px;
            }
            .os-header { text-align: center; margin-bottom: 12px; }
            .os-header h1 { color: #00843d; margin-bottom: 2px; font-size: 1.2em; }
            .os-header .subtitle { color: #666; font-size: 1em; }
            .os-info { display: flex; gap: 10px; margin-bottom: 10px; }
            .os-info-block { flex: 1; border: 1px solid #ddd; padding: 7px 10px; border-radius: 4px; }
            .os-info-block h3 { margin: 0 0 4px 0; color: #00843d; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 2px; }
            .os-details { margin-bottom: 8px; }
            .os-details h3 { color: #00843d; font-size: 1em; margin: 0 0 2px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
            .os-details p { white-space: pre-line; margin: 0 0 2px 0; }
            .os-signatures { display: flex; gap: 20px; margin-top: 18px; }
            .os-signature { border-top: 1px solid #000; padding-top: 6px; text-align: center; font-size: 0.95em; }
            .print-button {
                display: block;
                margin: 16px auto 0 auto;
                padding: 8px 18px;
                background: #39ff14;
                color: #111;
                border: none;
                border-radius: 5px;
                font-weight: bold;
                font-size: 1em;
                cursor: pointer;
            }
            @media print {
                body { background: #fff; }
                .print-button { display: none; }
                .os-container { box-shadow: none; margin: 0; }
            }
        </style>
        
        <div class="os-header">
            <h1>ORDEM DE SERVIÇO #${os.numero}</h1>
            <div class="subtitle">${statusText} - ${formatarData(os.data)}</div>
        </div>
        <div class="os-info">
            <div class="os-info-block">
                <h3>Solicitante</h3>
                <p><strong>Nome:</strong> ${solicitante.nome || 'Não informado'}</p>
                <p><strong>Setor:</strong> ${os.setor || 'Não informado'}</p>
                <p><strong>Contato:</strong> ${solicitante.contato || 'Não informado'}</p>
            </div>
            <div class="os-info-block">
                <h3>Serviço</h3>
                <p><strong>Equipamento:</strong> ${os.equipamento}</p>
                <p><strong>Patrimônio:</strong> ${os.serial || 'Não informado'}</p>
                <p><strong>Técnico:</strong> ${tecnico.nome || 'Não informado'} (${tecnico.especialidade || 'Não informado'})</p>
                <p><strong>Prazo:</strong> ${os.prazo ? formatarData(os.prazo) : 'Não definido'}</p>
            </div>
        </div>
        <div class="os-details">
            <h3>Problema Relatado</h3>
            <p>${os.problema}</p>
        </div>
        <div class="os-details">
            <h3>Diagnóstico Técnico</h3>
            <p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p>
            <p style="min-height:24px; border-bottom:1px solid #ccc;"></p>
        </div>
        <div class="os-details">
            <h3>Solução Aplicada</h3>
            <p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p>
            <p style="min-height:24px; border-bottom:1px solid #ccc;"></p>
        </div>
        <div class="os-signatures">
            <div class="os-signature">
                <p>______________________________</p>
                <p>Assinatura do Solicitante</p>
            </div>
            <div class="os-signature">
                <p>______________________________</p>
                <p>Assinatura do Técnico</p>
            </div>
        </div>
        <button class="print-button" onclick="window.print()">Imprimir OS</button>
    `;
    
    document.getElementById('os-print-content').innerHTML = html;
    document.getElementById('modal-os').style.display = 'block';
}
        
function fecharModalOS() {
    document.getElementById('modal-os').style.display = 'none';
}
        
function imprimirOS() {
    window.print();
}

// Funções para relatórios
function atualizarRelatorios() {
    // OS por status
    const statusCounts = {
        pendente: ordensServico.filter(os => os.status === 'pendente').length,
        andamento: ordensServico.filter(os => os.status === 'andamento').length,
        concluida: ordensServico.filter(os => os.status === 'concluida').length,
        cancelada: ordensServico.filter(os => os.status === 'cancelada').length
    };
    
    // OS por técnico
    const tecnicoCounts = {};
    tecnicos.forEach(tecnico => {
        tecnicoCounts[tecnico.nome] = ordensServico.filter(os => os.tecnicoId === tecnico.id).length;
    });
    
    // OS por setor
    const setorCounts = {};
    const setores = ['Produção', 'Manutenção', 'Qualidade', 'Logística', 'Administrativo', 'Outros'];
    setores.forEach(setor => {
        setorCounts[setor] = ordensServico.filter(os => os.setor === setor).length;
    });
    
    // Cria gráficos (simulação - na prática você usaria uma biblioteca como Chart.js)
    document.getElementById('chart-status').innerHTML = '<p>Gráfico: OS por Status</p>';
    document.getElementById('chart-tecnicos').innerHTML = '<p>Gráfico: OS por Técnico</p>';
    document.getElementById('chart-setores').innerHTML = '<p>Gráfico: OS por Setor</p>';
}
        
function gerarRelatorioCompleto() {
    // Implementação simplificada - na prática você geraria um PDF ou Excel
    alert('Relatório completo gerado com sucesso!');
}
        
function exportarHistoricoExcel() {
    let csv = 'Número,Solicitante,Setor,Equipamento,Data,Status,Técnico\n';
    
    const filtroSetor = document.getElementById('historico-setor').value;
    const periodo = parseInt(document.getElementById('historico-periodo').value);
    
    let hoje = new Date();
    let dataLimite = new Date();
    if (periodo > 0) {
        dataLimite.setDate(hoje.getDate() - periodo);
    }
    
    ordensServico.forEach(os => {
        // Aplica filtros
        if (filtroSetor && os.setor !== filtroSetor) return;
        if (periodo > 0) {
            const dataOS = new Date(os.data);
            if (dataOS < dataLimite) return;
        }
        
        const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
        const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
        
        const statusText = os.status === 'pendente' ? 'Pendente' :
                          os.status === 'andamento' ? 'Em Andamento' :
                          os.status === 'concluida' ? 'Concluída' : 'Cancelada';
        
        csv += `"#${os.numero}","${solicitante.nome || ''}","${os.setor}","${os.equipamento}","${formatarData(os.data)}","${statusText}","${tecnico.nome || ''}"\n`;
    });
    
    const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.setAttribute('download', 'historico_os.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
        
function imprimirHistorico() {
    const originalContents = document.body.innerHTML;
    const printContents = document.getElementById('historico-os').innerHTML;
    
    document.body.innerHTML = `
        <h1>Relatório de Histórico de OS</h1>
        ${printContents}
        <p>Gerado em: ${new Date().toLocaleDateString('pt-BR')}</p>
    `;
    
    window.print();
    document.body.innerHTML = originalContents;
}

// Funções utilitárias
function formatarData(dataString) {
    if (!dataString) return '';
    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
    return new Date(dataString).toLocaleDateString('pt-BR', options);
}

// Função para abrir OS em nova página
function abrirOSNovaPagina(osId) {
    const os = ordensServico.find(o => o.id === osId);
    if (!os) return;
    const solicitante = solicitantes.find(s => s.id === os.solicitanteId) || {};
    const tecnico = tecnicos.find(t => t.id === os.tecnicoId) || {};
    let statusText = os.status === 'pendente' ? 'Pendente' :
        os.status === 'andamento' ? 'Em Andamento' :
        os.status === 'concluida' ? 'Concluída' : 'Cancelada';
    const html = `<!DOCTYPE html>
<html lang='pt-BR'>
<head>
    <meta charset='UTF-8'>
    <title>Ordem de Serviço #${os.numero}</title>
    <style>
        body { font-family: Arial, sans-serif; background: #fff; margin: 0; padding: 0; }
        .os-container {
            max-width: 600px;
            margin: 16px auto;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 6px #0001;
            padding: 18px 22px 12px 22px;
            font-size: 13px;
        }
        .os-header { text-align: center; margin-bottom: 12px; }
        .os-header h1 { color: #00843d; margin-bottom: 2px; font-size: 1.2em; }
        .os-header .subtitle { color: #666; font-size: 1em; }
        .os-info { display: flex; gap: 10px; margin-bottom: 10px; }
        .os-info-block { flex: 1; border: 1px solid #ddd; padding: 7px 10px; border-radius: 4px; }
        .os-info-block h3 { margin: 0 0 4px 0; color: #00843d; font-size: 1em; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .os-details { margin-bottom: 8px; }
        .os-details h3 { color: #00843d; font-size: 1em; margin: 0 0 2px 0; border-bottom: 1px solid #eee; padding-bottom: 2px; }
        .os-details p { white-space: pre-line; margin: 0 0 2px 0; }
        .os-signatures { display: flex; gap: 20px; margin-top: 18px; }
        .os-signature { border-top: 1px solid #000; padding-top: 6px; text-align: center; font-size: 0.95em; }
        .print-button {
            display: block;
            margin: 16px auto 0 auto;
            padding: 8px 18px;
            background: #39ff14;
            color: #111;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1em;
            cursor: pointer;
        }
        @media print {
            body { background: #fff; }
            .print-button { display: none; }
            .os-container { box-shadow: none; margin: 0; }
        }
    </style>
</head>
<body>
    <div class='os-container'>
        <div class='os-header'>
            <h1>ORDEM DE SERVIÇO #${os.numero}</h1>
            <div class='subtitle'>${statusText} - ${formatarData(os.data)}</div>
        </div>
        <div class='os-info'>
            <div class='os-info-block'>
                <h3>Solicitante</h3>
                <p><strong>Nome:</strong> ${solicitante.nome || 'Não informado'}</p>
                <p><strong>Setor:</strong> ${os.setor || 'Não informado'}</p>
                <p><strong>Contato:</strong> ${solicitante.contato || 'Não informado'}</p>
            </div>
            <div class='os-info-block'>
                <h3>Serviço</h3>
                <p><strong>Equipamento:</strong> ${os.equipamento}</p>
                <p><strong>Patrimônio:</strong> ${os.serial || 'Não informado'}</p>
                <p><strong>Técnico:</strong> ${tecnico.nome || 'Não informado'} (${tecnico.especialidade || 'Não informado'})</p>
                <p><strong>Prazo:</strong> ${os.prazo ? formatarData(os.prazo) : 'Não definido'}</p>
            </div>
        </div>
        <div class='os-details'>
            <h3>Problema Relatado</h3>
            <p>${os.problema}</p>
        </div>
        <div class='os-details'>
            <h3>Diagnóstico Técnico</h3>
            <p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p>
            <p style="min-height:24px; border-bottom:1px solid #ccc;"></p>
        </div>
        <div class='os-details'>
            <h3>Solução Aplicada</h3>
            <p style="min-height:24px; border-bottom:1px solid #ccc; margin-bottom:4px;"></p>
            <p style="min-height:24px; border-bottom:1px solid #ccc;"></p>
        </div>
        <div class='os-signatures'>
            <div class='os-signature'>
                <p>______________________________</p>
                <p>Assinatura do Solicitante</p>
            </div>
            <div class='os-signature'>
                <p>______________________________</p>
                <p>Assinatura do Técnico</p>
            </div>
        </div>
        <button class='print-button' onclick='window.print()'>Imprimir OS</button>
    </div>
</body>
</html>`;
    const novaJanela = window.open('', '_blank');
    novaJanela.document.write(html);
    novaJanela.document.close();
}
    </script>
</body>
</html>